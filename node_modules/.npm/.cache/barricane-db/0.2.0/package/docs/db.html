<!DOCTYPE html>  <html> <head>   <title>db.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="example-create-database.html">                 example-create-database.js               </a>                                           <a class="source" href="example-model.html">                 example-model.js               </a>                                           <a class="source" href="example-read-database.html">                 example-read-database.js               </a>                                           <a class="source" href="barricane-db.html">                 barricane-db.js               </a>                                           <a class="source" href="db.html">                 db.js               </a>                                           <a class="source" href="disk-io.html">                 disk-io.js               </a>                                           <a class="source" href="swoj-codec.html">                 swoj-codec.js               </a>                                           <a class="source" href="util.html">                 util.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               db.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Copyright (c) 2010 Barricane Technology Ltd., All Rights Reserved.
Released under the MIT open source licence.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This module contains the database code.
It specifically eschews serialisation and io concerns.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-uuid&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">dio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./disk-io&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./util&#39;</span><span class="p">)</span>
  <span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The DB constructor represents the database. In almost all circumstances only
one database will exist per process. More can be used, if needed, but the
application will become more complex, as it cannot use
<code>process.db</code> in constructors.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">DB</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>magic</code> is a string which must not normally occur in your application's
property names. Double underscore is the default.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">magic</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">magic</span> <span class="o">||</span> <span class="s2">&quot;__&quot;</span><span class="p">;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Set up some almost constants.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">CONSTRUCTOR_TAG</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span> <span class="o">+</span> <span class="s1">&#39;constructor&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">UUID_TAG</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span> <span class="o">+</span> <span class="s1">&#39;uuid&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">DATE_TAG</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span> <span class="o">+</span> <span class="s1">&#39;date&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span><span class="p">;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>uuid</code> is the function used to generate unique IDs for each
managed object. It is overridable for testing purposes, where the IDs
need to be deterministic.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">||</span> <span class="nx">uuid</span><span class="p">;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The database needs to keep track of constructors, in order to be able
to reconstruct objects when opening a database.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">constructors</span> <span class="o">=</span> <span class="p">{};</span>
	</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>instances</code> contains all of the <em>managed</em> objects, indexed
by uuid.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">instances</span> <span class="o">=</span> <span class="p">{};</span>
	</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>stores</code> contains all of the <em>managed</em> objects' data, indexed
by uuid. The data is separate as the properties in the instances have
custom getters/setters, via <code><strong>defineSetter</strong></code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">stores</span> <span class="o">=</span> <span class="p">{};</span>
	</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The <code>persist</code> flag is made false during database 
reconstruction, otherwise we would get into a frightful pickle.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">persist</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The <code>io</code> manager is responsible for IO. By default BarricaneDB
uses simple disk-based persistence. The <code>io</code> manager is
separated so that it can be optionally replaced with ReplicationIO at
some point in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">io</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">io</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">dio</span><span class="p">.</span><span class="nx">DiskIO</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>This opens the database for use.  It only exists because I'm not sure about
the validity of calling instance members from within the constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">openSync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">persist</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	
	<span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">openSync</span><span class="p">();</span>
	
	<span class="k">this</span><span class="p">.</span><span class="nx">persist</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This must be called once for every instance which needs to be persisted.
It is idiomatic to do this in the constructor, using a global 
<code>process.db</code> database.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerInstance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">force</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Skip register instance at this stage, unless forced.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">persist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Only create a new UUID if one does not exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">instance</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">UUID_TAG</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">UUID_TAG</span><span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">uuid</span><span class="p">();</span>
	
	<span class="k">this</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">instance</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">UUID_TAG</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="p">{};</span>	<span class="c1">// the backing store for the instance data</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">stores</span><span class="p">[</span><span class="nx">instance</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">UUID_TAG</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">store</span><span class="p">;</span>
	
	<span class="nx">util</span><span class="p">.</span><span class="nx">ownRealKeys</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">magic</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">store</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
		<span class="nx">instance</span><span class="p">.</span><span class="nx">__defineSetter__</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">store</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">persist</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">that</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">});</span>
		<span class="nx">instance</span><span class="p">.</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">store</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
		<span class="p">});</span>
	<span class="p">});</span>
	
	</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Finally add the object to the log, if the database is not in the middle
of reconstruction.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">persist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">persist</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The database needs to keep track of constructors, so that it can call them 
when loading a database.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerConstructors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span> 
	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">constructors</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This is a very inefficient and rudimentary query.  It is envisaged that most
objects will be accessed via O(1) traversal, rather than this naive O(N) 
lookup.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[];</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">instances</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">===</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="nx">tmp</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Just a wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteSync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">deleteSync</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Just a wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Export the symbols.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">DB</span> <span class="o">=</span> <span class="nx">DB</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> <script type="text/javascript">    var _gaq = _gaq || [];   _gaq.push(['_setAccount', 'UA-732703-12']);   _gaq.push(['_trackPageview']);    (function() {     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);   })();  </script> </body> </html> 